# 2026-02-11

## 11:57 — Fix: Multiple React Copies Causing "Invalid Hook Call" in Plugin Modes

### Core Decision/Topic

Resolve "Invalid hook call" errors caused by multiple React 18.3.1 instances loaded as distinct module objects across three plugin execution modes (Worker, WebSocket client, main thread).

### Root Cause

`host-react-demo` depends on `react@^19.2.0`, causing pnpm to hoist React 19 to the monorepo root `node_modules/`. All other packages need React 18 (required by `react-reconciler@0.29.2`), so pnpm creates **separate copies** of `react@18.3.1` in each package's own `node_modules/`. When code from different packages imports `react`, they get different module objects — `react-reconciler` sets the hooks dispatcher on one instance while the component reads from another, resulting in a null dispatcher.

### Options Considered

1. **pnpm overrides** to force a single React version globally — would break `host-react-demo` which legitimately needs React 19 for its own UI.
2. **`resolve.dedupe`** in Vite config — resolves from monorepo root, which picks up React 19 instead of 18, breaking `react-reconciler@0.29.2` (missing `ReactCurrentOwner`).
3. **`Bun.build()` bundling alone** for client mode — the bundler still follows pnpm's per-package `node_modules`, including 4 separate copies of React in the output.
4. **Bun bundler plugin (`reactDedup`) + Vite `resolve.alias`** — force all `react` imports to resolve from a single known React 18 location at build time (Bun) and dev-serve time (Vite).

### Final Decision & Rationale

Option 4: Two-pronged approach matching the two code paths.

**For Worker & WebSocket client modes** (Bun.build): A `reactDedup` Bun bundler plugin intercepts all `react` and `react/*` imports via `onResolve` and redirects them to `plugin-example/node_modules/react` using `Bun.resolveSync()`. This reduced `useState` definitions in the client bundle from 4 to 1.

**For main-thread mode** (Vite dev server): Added `react: catalog:` as a dependency in `host-svelte-demo/package.json`, giving the host its own local `node_modules/react` pointing to React 18.3.1 via the pnpm catalog. Then `resolve.alias` in `vite.config.ts` points `react` to `./node_modules/react` — the host's own local copy. Since the app uses `@sveltejs/adapter-static` (no SSR), there is no CJS/ESM incompatibility to handle on the server side.

The pnpm catalog was also bumped from `^18.3.0` to `^18.3.1` to match `react-reconciler@0.29.2`'s actual peer dependency requirement.

### Key Changes Made

| File | Change |
|------|--------|
| `examples/plugin-example/build.ts` | Added `reactDedup` Bun plugin; added client entrypoints build (`target: "bun"`); applied plugin to both worker and client builds |
| `examples/plugin-example/package.json` | Client scripts now run bundled `dist/*.client.js` instead of raw source; `client` script runs `bun build.ts` first; added `npm-run-all2`; fixed `server`/`client` scripts to use `run-p` |
| `examples/host-svelte-demo/vite.config.ts` | Added `resolve.alias` for react -> `./node_modules/react` (local React 18 via catalog) |
| `examples/host-svelte-demo/package.json` | Added `react: catalog:` dependency, giving the host its own React 18.3.1 copy for alias resolution |
| `pnpm-workspace.yaml` | Bumped catalog `react` from `^18.3.0` to `^18.3.1`; removed unnecessary quotes from package globs |

### Future Considerations

- ~~**React 19 migration**: When `react-reconciler` supports React 19, the entire plugin ecosystem could standardize on one version, eliminating the need for these workarounds.~~ **Done** — see entry below.
- **host-react-demo isolation**: Consider whether `host-react-demo` should be excluded from the pnpm workspace or use a separate lockfile to avoid polluting the root dependency tree with React 19. **Moot** — all packages now on React 19.

---

## 15:30 — Upgrade React 18 → 19 Across Monorepo

### Core Decision/Topic

Upgrade the entire monorepo from React 18 to React 19, unifying on a single React version and eliminating all deduplication workarounds that were needed to prevent "Invalid hook call" errors from multiple React copies.

### Options Considered

1. **Keep React 18 with dedup workarounds** — the Bun `reactDedup` plugin and Vite `resolve.alias` hack work but are fragile, require maintenance, and obscure the real dependency graph.
2. **Upgrade to React 19 everywhere** — `react-reconciler@0.33.0` now supports React 19. One version in the pnpm catalog means pnpm hoists a single copy; no dedup hacks needed.
3. **Partial upgrade** (keep some packages on 18) — would perpetuate the multi-version problem.

### Final Decision & Rationale

Option 2: Full upgrade to React 19. The `react-reconciler@0.33.0` release made this viable. With a single React version in the catalog, pnpm naturally deduplicates to one copy across the entire dependency tree. This eliminates the root cause rather than working around it.

### Key Changes Made

| File | Change |
|------|--------|
| `pnpm-workspace.yaml` | Catalog: `react` → `^19.2.0`, added `react-reconciler: ^0.33.0` |
| `packages/react-renderer/package.json` | `react-reconciler` → `catalog:`, peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, `@types/react-reconciler` → `^0.32.0`, devDep react → `catalog:` |
| `packages/tui-renderer/package.json` | Same changes as react-renderer |
| `packages/host-sdk/package.json` | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, devDep react → `catalog:` |
| `packages/runtime/package.json` | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, devDep react → `catalog:` |
| `examples/plugin-api/package.json` | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0` |
| `examples/plugin-example/package.json` | `@types/react` → `^19.0.0` |
| `examples/tui-demo/package.json` | `@types/react` → `^19.0.0` |
| `packages/react-renderer/src/reconciler/renderer.ts` | `createContainer`: 8 args → 11 args (ConcurrentRoot, error handlers), import `ConcurrentRoot` from `react-reconciler/constants` |
| `packages/tui-renderer/src/reconciler/renderer.ts` | Same createContainer changes |
| `packages/react-renderer/src/reconciler/host-config.ts` | HostConfig generics: removed `UpdatePayload`, added `FormInstance` (`never`) + `TransitionStatus` (`null`). Removed `prepareUpdate` (dropped in R19). Updated `commitUpdate` signature. Replaced `getCurrentEventPriority` with `setCurrentUpdatePriority`/`getCurrentUpdatePriority`/`resolveUpdatePriority` trio. Added 13 new React 19 methods (suspense/transition stubs). |
| `packages/tui-renderer/src/reconciler/host-config.ts` | Same host-config changes |
| `examples/plugin-example/build.ts` | Removed `reactDedup` Bun plugin and its usage |
| `examples/host-svelte-demo/vite.config.ts` | Removed `resolve.alias` for react, removed `path`/`fileURLToPath` imports |
| `examples/host-svelte-demo/package.json` | Removed `react: catalog:` from dependencies |
| `pnpm-lock.yaml` | Regenerated from scratch (old lockfile had broken symlink targets for tsdown) |

### React 19 Reconciler API Changes (reference)

Key differences from the React 18 reconciler API that required code changes:

- **HostConfig generics**: 13 → 14 params. `UpdatePayload` removed; `FormInstance` and `TransitionStatus` added.
- **`prepareUpdate`**: Removed entirely. The reconciler now always calls `commitUpdate` on prop changes.
- **`commitUpdate` signature**: No longer receives `updatePayload`; takes `(instance, type, prevProps, nextProps, internalHandle)`.
- **`createContainer`**: 8 → 11 args. Uses `ConcurrentRoot` constant instead of `0`. Four error handler callbacks (onRecoverableError, onUncaughtError, onCaughtError, onCaughtError).
- **Priority system**: `getCurrentEventPriority` replaced by `setCurrentUpdatePriority`/`getCurrentUpdatePriority`/`resolveUpdatePriority` trio using `DefaultEventPriority`/`NoEventPriority` from `react-reconciler/constants`.
- **New required methods**: `shouldAttemptEagerTransition`, `maySuspendCommit`, `NotPendingTransition`, `HostTransitionContext`, `resetFormInstance`, `requestPostPaintCallback`, `trackSchedulerEvent`, `resolveEventType`, `resolveEventTimeStamp`, `preloadInstance`, `startSuspendingCommit`, `suspendInstance`, `waitForCommitToBeReady`.

### Future Considerations

- **`vendors/svelte-react-render`** submodule still uses `react-reconciler@^0.29.2`. It has its own repo and needs a separate upgrade commit. Not currently imported by any core packages or examples.
- **`host-react-demo`** was already on React 19 — no changes needed there, and it no longer creates a version conflict.
- **`plugin-solid-example`** build requires `bun` in PATH; fails in environments where only system pnpm/node are available. Pre-existing issue, not related to this upgrade.
