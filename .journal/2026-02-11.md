# 2026-02-11

## 11:57 — Fix: Multiple React Copies Causing "Invalid Hook Call" in Plugin Modes

### Core Decision/Topic

Resolve "Invalid hook call" errors caused by multiple React 18.3.1 instances loaded as distinct module objects across three plugin execution modes (Worker, WebSocket client, main thread).

### Root Cause

`host-react-demo` depends on `react@^19.2.0`, causing pnpm to hoist React 19 to the monorepo root `node_modules/`. All other packages need React 18 (required by `react-reconciler@0.29.2`), so pnpm creates **separate copies** of `react@18.3.1` in each package's own `node_modules/`. When code from different packages imports `react`, they get different module objects — `react-reconciler` sets the hooks dispatcher on one instance while the component reads from another, resulting in a null dispatcher.

### Options Considered

1. **pnpm overrides** to force a single React version globally — would break `host-react-demo` which legitimately needs React 19 for its own UI.
2. **`resolve.dedupe`** in Vite config — resolves from monorepo root, which picks up React 19 instead of 18, breaking `react-reconciler@0.29.2` (missing `ReactCurrentOwner`).
3. **`Bun.build()` bundling alone** for client mode — the bundler still follows pnpm's per-package `node_modules`, including 4 separate copies of React in the output.
4. **Bun bundler plugin (`reactDedup`) + Vite `resolve.alias`** — force all `react` imports to resolve from a single known React 18 location at build time (Bun) and dev-serve time (Vite).

### Final Decision & Rationale

Option 4: Two-pronged approach matching the two code paths.

**For Worker & WebSocket client modes** (Bun.build): A `reactDedup` Bun bundler plugin intercepts all `react` and `react/*` imports via `onResolve` and redirects them to `plugin-example/node_modules/react` using `Bun.resolveSync()`. This reduced `useState` definitions in the client bundle from 4 to 1.

**For main-thread mode** (Vite dev server): Added `react: catalog:` as a dependency in `host-svelte-demo/package.json`, giving the host its own local `node_modules/react` pointing to React 18.3.1 via the pnpm catalog. Then `resolve.alias` in `vite.config.ts` points `react` to `./node_modules/react` — the host's own local copy. Since the app uses `@sveltejs/adapter-static` (no SSR), there is no CJS/ESM incompatibility to handle on the server side.

The pnpm catalog was also bumped from `^18.3.0` to `^18.3.1` to match `react-reconciler@0.29.2`'s actual peer dependency requirement.

### Key Changes Made

| File                                       | Change                                                                                                                                                                                   |
| ------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `examples/plugin-example/build.ts`         | Added `reactDedup` Bun plugin; added client entrypoints build (`target: "bun"`); applied plugin to both worker and client builds                                                         |
| `examples/plugin-example/package.json`     | Client scripts now run bundled `dist/*.client.js` instead of raw source; `client` script runs `bun build.ts` first; added `npm-run-all2`; fixed `server`/`client` scripts to use `run-p` |
| `examples/host-svelte-demo/vite.config.ts` | Added `resolve.alias` for react -> `./node_modules/react` (local React 18 via catalog)                                                                                                   |
| `examples/host-svelte-demo/package.json`   | Added `react: catalog:` dependency, giving the host its own React 18.3.1 copy for alias resolution                                                                                       |
| `pnpm-workspace.yaml`                      | Bumped catalog `react` from `^18.3.0` to `^18.3.1`; removed unnecessary quotes from package globs                                                                                        |

### Future Considerations

- ~~**React 19 migration**: When `react-reconciler` supports React 19, the entire plugin ecosystem could standardize on one version, eliminating the need for these workarounds.~~ **Done** — see entry below.
- **host-react-demo isolation**: Consider whether `host-react-demo` should be excluded from the pnpm workspace or use a separate lockfile to avoid polluting the root dependency tree with React 19. **Moot** — all packages now on React 19.

---

## 15:30 — Upgrade React 18 → 19 Across Monorepo

### Core Decision/Topic

Upgrade the entire monorepo from React 18 to React 19, unifying on a single React version and eliminating all deduplication workarounds that were needed to prevent "Invalid hook call" errors from multiple React copies.

### Options Considered

1. **Keep React 18 with dedup workarounds** — the Bun `reactDedup` plugin and Vite `resolve.alias` hack work but are fragile, require maintenance, and obscure the real dependency graph.
2. **Upgrade to React 19 everywhere** — `react-reconciler@0.33.0` now supports React 19. One version in the pnpm catalog means pnpm hoists a single copy; no dedup hacks needed.
3. **Partial upgrade** (keep some packages on 18) — would perpetuate the multi-version problem.

### Final Decision & Rationale

Option 2: Full upgrade to React 19. The `react-reconciler@0.33.0` release made this viable. With a single React version in the catalog, pnpm naturally deduplicates to one copy across the entire dependency tree. This eliminates the root cause rather than working around it.

### Key Changes Made

| File                                                    | Change                                                                                                                                                                                                                                                                                                                                                                         |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `pnpm-workspace.yaml`                                   | Catalog: `react` → `^19.2.0`, added `react-reconciler: ^0.33.0`                                                                                                                                                                                                                                                                                                                |
| `packages/react-renderer/package.json`                  | `react-reconciler` → `catalog:`, peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, `@types/react-reconciler` → `^0.32.0`, devDep react → `catalog:`                                                                                                                                                                                                                            |
| `packages/tui-renderer/package.json`                    | Same changes as react-renderer                                                                                                                                                                                                                                                                                                                                                 |
| `packages/host-sdk/package.json`                        | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, devDep react → `catalog:`                                                                                                                                                                                                                                                                                                    |
| `packages/runtime/package.json`                         | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0`, devDep react → `catalog:`                                                                                                                                                                                                                                                                                                    |
| `examples/plugin-api/package.json`                      | Peer dep → `^19.0.0`, `@types/react` → `^19.0.0`                                                                                                                                                                                                                                                                                                                               |
| `examples/plugin-example/package.json`                  | `@types/react` → `^19.0.0`                                                                                                                                                                                                                                                                                                                                                     |
| `examples/tui-demo/package.json`                        | `@types/react` → `^19.0.0`                                                                                                                                                                                                                                                                                                                                                     |
| `packages/react-renderer/src/reconciler/renderer.ts`    | `createContainer`: 8 args → 11 args (ConcurrentRoot, error handlers), import `ConcurrentRoot` from `react-reconciler/constants`                                                                                                                                                                                                                                                |
| `packages/tui-renderer/src/reconciler/renderer.ts`      | Same createContainer changes                                                                                                                                                                                                                                                                                                                                                   |
| `packages/react-renderer/src/reconciler/host-config.ts` | HostConfig generics: removed `UpdatePayload`, added `FormInstance` (`never`) + `TransitionStatus` (`null`). Removed `prepareUpdate` (dropped in R19). Updated `commitUpdate` signature. Replaced `getCurrentEventPriority` with `setCurrentUpdatePriority`/`getCurrentUpdatePriority`/`resolveUpdatePriority` trio. Added 13 new React 19 methods (suspense/transition stubs). |
| `packages/tui-renderer/src/reconciler/host-config.ts`   | Same host-config changes                                                                                                                                                                                                                                                                                                                                                       |
| `examples/plugin-example/build.ts`                      | Removed `reactDedup` Bun plugin and its usage                                                                                                                                                                                                                                                                                                                                  |
| `examples/host-svelte-demo/vite.config.ts`              | Removed `resolve.alias` for react, removed `path`/`fileURLToPath` imports                                                                                                                                                                                                                                                                                                      |
| `examples/host-svelte-demo/package.json`                | Removed `react: catalog:` from dependencies                                                                                                                                                                                                                                                                                                                                    |
| `pnpm-lock.yaml`                                        | Regenerated from scratch (old lockfile had broken symlink targets for tsdown)                                                                                                                                                                                                                                                                                                  |

### React 19 Reconciler API Changes (reference)

Key differences from the React 18 reconciler API that required code changes:

- **HostConfig generics**: 13 → 14 params. `UpdatePayload` removed; `FormInstance` and `TransitionStatus` added.
- **`prepareUpdate`**: Removed entirely. The reconciler now always calls `commitUpdate` on prop changes.
- **`commitUpdate` signature**: No longer receives `updatePayload`; takes `(instance, type, prevProps, nextProps, internalHandle)`.
- **`createContainer`**: 8 → 11 args. Uses `ConcurrentRoot` constant instead of `0`. Four error handler callbacks (onRecoverableError, onUncaughtError, onCaughtError, onCaughtError).
- **Priority system**: `getCurrentEventPriority` replaced by `setCurrentUpdatePriority`/`getCurrentUpdatePriority`/`resolveUpdatePriority` trio using `DefaultEventPriority`/`NoEventPriority` from `react-reconciler/constants`.
- **New required methods**: `shouldAttemptEagerTransition`, `maySuspendCommit`, `NotPendingTransition`, `HostTransitionContext`, `resetFormInstance`, `requestPostPaintCallback`, `trackSchedulerEvent`, `resolveEventType`, `resolveEventTimeStamp`, `preloadInstance`, `startSuspendingCommit`, `suspendInstance`, `waitForCommitToBeReady`.

### Future Considerations

- **`vendors/svelte-react-render`** submodule still uses `react-reconciler@^0.29.2`. It has its own repo and needs a separate upgrade commit. Not currently imported by any core packages or examples.
- **`host-react-demo`** was already on React 19 — no changes needed there, and it no longer creates a version conflict.
- **`plugin-solid-example`** build requires `bun` in PATH; fails in environments where only system pnpm/node are available. Pre-existing issue, not related to this upgrade.

---

## 13:40 — Fix: kkrpc Bundling Strategy for Optional Peer Dependencies

### Core Decision/Topic

Resolve bundling failures where kkrpc's optional peer dependencies (`amqplib`, `kafkajs`, `ioredis`) were being included in builds despite not being used, causing "Could not resolve" errors during `bun dev:all`.

### Root Cause

kkrpc's main entry point (`mod.ts`) unconditionally exported ALL adapters including optional ones with heavy peer dependencies. When bundlers (Bun, Vite) processed imports from `kkrpc`, they tried to resolve these optional dependencies even though the consuming code never used RabbitMQ, Kafka, or Redis adapters.

### Options Considered

1. **Mark optional deps as external in tsdown config** — would still require consumers to configure their bundlers to handle externals, leaking implementation details.
2. **Use dynamic imports for optional adapters** — adds complexity, async initialization, and breaks tree-shaking for users who do want these adapters.
3. **Don't export optional adapters from main entry** — keep them as separate subpath exports (`kkrpc/rabbitmq`, `kkrpc/kafka`, etc.). Consumers import only what they need.

### Final Decision & Rationale

Option 3: Clean separation between core and optional adapters. The main `kkrpc` entry now only exports core adapters (worker, websocket, http, hono-websocket, elysia-websocket). Optional adapters with peer dependencies must be imported explicitly via subpaths:

```typescript
// Core - no external deps needed
import { RPCChannel, WorkerChildIO } from "kkrpc";

// Optional - only import if you have the peer dep installed
import { RabbitMQIO } from "kkrpc/rabbitmq"; // requires amqplib
```

This follows the principle that consumers shouldn't need to know about or configure around dependencies they don't use.

Also fixed package.json exports to use `.mjs` extension (tsdown outputs `.mjs`, not `.js`).

### Key Changes Made

| File                                            | Change                                                                                |
| ----------------------------------------------- | ------------------------------------------------------------------------------------- |
| `vendors/kkrpc/packages/kkrpc/mod.ts`           | Removed exports for `rabbitmq`, `kafka`, `redis-streams`, `nats`, `socketio` adapters |
| `vendors/kkrpc/packages/kkrpc/package.json`     | Fixed ESM export extensions from `.js` to `.mjs`                                      |
| `vendors/kkrpc/packages/kkrpc/tsdown.config.ts` | Added `external` array for optional peer deps (belt-and-suspenders)                   |

---

## 13:45 — Merge dev:all Scripts for Multi-Framework Plugin Support

### Core Decision/Topic

Merge `dev:all` (React plugins) and `dev:all:solid` (Solid plugins) into a single `dev:all` command that runs both framework demos simultaneously with one bridge server.

### Context

Previously, running both React and Solid demos required separate commands and separate bridge servers, or manually coordinating ports. The bridge server already supported `/solid/:filename` routes, but there was no unified way to start everything.

### Options Considered

1. **Keep separate commands** — requires running two bridges on different ports, complicates the demo workflow.
2. **Unified command with sequential startup** — build all plugins first, then run all clients, then start SvelteKit. Simpler but slower feedback loop.
3. **Unified command with parallel startup** — use `run-p` to start bridge, build+run plugins, and SvelteKit in parallel. Fastest but requires careful script coordination.

### Final Decision & Rationale

Option 3: Parallel startup with `run-p`. Plugins already use unique IDs (`simple-demo`, `advanced-demo`, `solid-simple-demo`, `solid-advanced-demo`) so they can all connect to the same bridge without conflicts. The bridge server serves worker files at framework-specific paths:

- `/react/:filename` → React plugins
- `/solid/:filename` → Solid plugins
- `/:filename` → Legacy/React (backward compatibility)

### Key Changes Made

| File                                     | Change                                                                                                                                                          |
| ---------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `examples/host-svelte-demo/package.json` | Replaced `dev:all`/`dev:all:solid` with unified `dev:all`. New scripts: `plugins:all`, `plugins:build`, `plugins:run`, `plugins:run:react`, `plugins:run:solid` |
| `examples/bridge-server/src/index.ts`    | Added `/react/:filename` route, reorganized routes for clarity                                                                                                  |

### Usage

```bash
cd examples/host-svelte-demo
pnpm dev:all
```

This starts:

- Bridge server (port 3000)
- All React plugins (simple-demo, advanced-demo)
- All Solid plugins (solid-simple-demo, solid-advanced-demo)
- SvelteKit dev server (port 5173)

---

## 16:00 — Benchmark Plugins with Incremental vs Full-Tree Comparison

### Core Decision/Topic

Add comprehensive benchmark plugins for both React and Solid to measure and compare performance between full-tree and incremental update modes.

### Context

The uniview protocol previously sent the entire UINode tree over RPC on every render. An earlier attempt at incremental updates had critical bugs (random text node IDs, inconsistent tracking, broken MutableTree.applySetText). This implementation re-does incremental updates cleanly with proper text node ID stability and maintains full-tree mode as the default.

### Key Metrics Added

**Operation Metrics (Per Click):**
- Operations performed, last operation time, avg time/operation
- Messages in last operation, avg messages/op, avg bytes/op

**Message Metrics (Per Message):**
- Total messages, total bytes (MB)
- Bytes/message, time/message (microseconds)

### Options Considered

1. **Single benchmark mode** — only test one mode at a time, no comparison possible.
2. **Dual mode with manual switching** — build separate worker files for full vs incremental, load based on user selection.
3. **Runtime mode selection** — pass mode as parameter to plugin, single build handles both.

### Final Decision & Rationale

Option 2: Separate worker builds for full and incremental modes. This ensures clean separation of concerns and allows accurate measurement without runtime overhead. Each mode has its own entry point:

- `benchmark-full.worker.ts` → `benchmark-full.worker.js`
- `benchmark-incremental.worker.ts` → `benchmark-incremental.worker.js`

Same pattern for WebSocket client entries and Solid variants (8 total entry points).

### Key Changes Made

| File | Change |
| ---- | ------ |
| `packages/protocol/src/mutations.ts` | Mutation type definitions (AppendChild, InsertBefore, RemoveChild, SetText, SetProps, SetRoot) |
| `packages/protocol/src/rpc.ts` | Added `applyMutations(mutations: Mutation[])` to PluginToHostAPI |
| `packages/react-renderer/src/mutation/mutation-collector.ts` | Class to collect mutations during React commit phase |
| `packages/solid-renderer/src/mutation/mutation-collector.ts` | Solid-specific mutation collector |
| `packages/host-sdk/src/mutable-tree.ts` | Host-side tree mutation application with text node indexing |
| `packages/runtime/src/runtime.ts` | Mode selection, stats tracking on `globalThis.__uniview_stats` |
| `examples/plugin-example/src/benchmark.tsx` | React benchmark component with 1000 initial items, max 2000 |
| `examples/plugin-solid-example/src/benchmark.tsx` | Solid benchmark component |
| `examples/host-svelte-demo/src/routes/+page.svelte` | Update mode toggle, benchmark demo tab, query param persistence |

### Query Parameter Persistence

Added URL query params to preserve selections across refresh:
- `?framework=react|solid`
- `?demo=simple|advanced|benchmark`
- `?runtime=worker|main-thread|node-server`
- `?update=full|incremental`

### Performance Results (Sample)

With 1000 initial items (max 2000):
- **Full Tree**: ~87KB/message, fewer messages
- **Incremental**: ~69KB/message, more messages but smaller payloads
- **Operation Time**: Incremental typically faster (6-7ms vs 8-9ms)

### Future Considerations

- Consider increasing initial items further (5000?) for even more stress testing
- Add visualization/graphing of metrics over time
- Export benchmark results to JSON for automated performance regression testing
- Add "stress test" mode that rapidly adds/removes items to find breaking points

---

## 16:45 — Fix: Benchmark Node.js/WebSocket Loading Issue

### Core Decision/Topic

Fix benchmark plugins failing to load in Node.js/WebSocket mode while working correctly in Web Worker mode.

### Root Cause

Two issues discovered:

1. **Wrong default port**: Benchmark `.client.ts` files defaulted to `ws://localhost:3001`, but the bridge server runs on port 3000. Simple/advanced demo clients correctly used port 3000.

2. **Missing benchmark client scripts**: The `plugins:run:react` and `plugins:run:solid` npm scripts only started `client:simple` and `client:advanced`, but not the benchmark clients. When selecting "Benchmark" demo with "Node.js" runtime, no plugin process was running to connect to the bridge.

### Options Considered

1. **Just fix the port** — would still fail because benchmark clients weren't being started.
2. **Just add the scripts** — would still fail because wrong port meant connection to non-existent server.
3. **Fix both port and scripts** — complete fix addressing both root causes.

### Final Decision & Rationale

Option 3: Both fixes required for working benchmark in Node.js mode. Port 3000 is the standard bridge server port used across all other clients. Adding benchmark clients to the run scripts ensures they're available when the host requests them.

### Key Changes Made

| File | Change |
| ---- | ------ |
| `examples/plugin-example/src/benchmark-full.client.ts` | Port 3001 → 3000 |
| `examples/plugin-example/src/benchmark-incremental.client.ts` | Port 3001 → 3000 |
| `examples/plugin-solid-example/src/benchmark-full.client.ts` | Port 3001 → 3000 |
| `examples/plugin-solid-example/src/benchmark-incremental.client.ts` | Port 3001 → 3000 |
| `examples/plugin-example/package.json` | Added `client:benchmark-full` and `client:benchmark-incremental` scripts |
| `examples/plugin-solid-example/package.json` | Added `client:benchmark-full` and `client:benchmark-incremental` scripts |
| `examples/host-svelte-demo/package.json` | Updated `plugins:run:react` and `plugins:run:solid` to include all 4 clients |

### Verification Steps

1. Build all packages: `pnpm build`
2. Run demo: `cd examples/host-svelte-demo && pnpm dev:all`
3. Open http://localhost:5173
4. Select "Benchmark" demo, "Node.js" runtime, "full" or "incremental" update mode
5. Verify 1000 items load and operations (add/remove/update) work correctly
