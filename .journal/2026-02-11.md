# 2026-02-11

## 11:57 — Fix: Multiple React Copies Causing "Invalid Hook Call" in Plugin Modes

### Core Decision/Topic

Resolve "Invalid hook call" errors caused by multiple React 18.3.1 instances loaded as distinct module objects across three plugin execution modes (Worker, WebSocket client, main thread).

### Root Cause

`host-react-demo` depends on `react@^19.2.0`, causing pnpm to hoist React 19 to the monorepo root `node_modules/`. All other packages need React 18 (required by `react-reconciler@0.29.2`), so pnpm creates **separate copies** of `react@18.3.1` in each package's own `node_modules/`. When code from different packages imports `react`, they get different module objects — `react-reconciler` sets the hooks dispatcher on one instance while the component reads from another, resulting in a null dispatcher.

### Options Considered

1. **pnpm overrides** to force a single React version globally — would break `host-react-demo` which legitimately needs React 19 for its own UI.
2. **`resolve.dedupe`** in Vite config — resolves from monorepo root, which picks up React 19 instead of 18, breaking `react-reconciler@0.29.2` (missing `ReactCurrentOwner`).
3. **`Bun.build()` bundling alone** for client mode — the bundler still follows pnpm's per-package `node_modules`, including 4 separate copies of React in the output.
4. **Bun bundler plugin (`reactDedup`) + Vite `resolve.alias`** — force all `react` imports to resolve from a single known React 18 location at build time (Bun) and dev-serve time (Vite).

### Final Decision & Rationale

Option 4: Two-pronged approach matching the two code paths.

**For Worker & WebSocket client modes** (Bun.build): A `reactDedup` Bun bundler plugin intercepts all `react` and `react/*` imports via `onResolve` and redirects them to `plugin-example/node_modules/react` using `Bun.resolveSync()`. This reduced `useState` definitions in the client bundle from 4 to 1.

**For main-thread mode** (Vite dev server): Added `react: catalog:` as a dependency in `host-svelte-demo/package.json`, giving the host its own local `node_modules/react` pointing to React 18.3.1 via the pnpm catalog. Then `resolve.alias` in `vite.config.ts` points `react` to `./node_modules/react` — the host's own local copy. Since the app uses `@sveltejs/adapter-static` (no SSR), there is no CJS/ESM incompatibility to handle on the server side.

The pnpm catalog was also bumped from `^18.3.0` to `^18.3.1` to match `react-reconciler@0.29.2`'s actual peer dependency requirement.

### Key Changes Made

| File | Change |
|------|--------|
| `examples/plugin-example/build.ts` | Added `reactDedup` Bun plugin; added client entrypoints build (`target: "bun"`); applied plugin to both worker and client builds |
| `examples/plugin-example/package.json` | Client scripts now run bundled `dist/*.client.js` instead of raw source; `client` script runs `bun build.ts` first; added `npm-run-all2`; fixed `server`/`client` scripts to use `run-p` |
| `examples/host-svelte-demo/vite.config.ts` | Added `resolve.alias` for react -> `./node_modules/react` (local React 18 via catalog) |
| `examples/host-svelte-demo/package.json` | Added `react: catalog:` dependency, giving the host its own React 18.3.1 copy for alias resolution |
| `pnpm-workspace.yaml` | Bumped catalog `react` from `^18.3.0` to `^18.3.1`; removed unnecessary quotes from package globs |

### Future Considerations

- **React 19 migration**: When `react-reconciler` supports React 19, the entire plugin ecosystem could standardize on one version, eliminating the need for these workarounds.
- **host-react-demo isolation**: Consider whether `host-react-demo` should be excluded from the pnpm workspace or use a separate lockfile to avoid polluting the root dependency tree with React 19.
